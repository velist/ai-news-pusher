# 🔧 AI新闻推送系统故障诊断与修复指南

## 🚨 紧急安全提醒

**如果您刚才分享了GitHub令牌，请立即执行：**
1. 访问 https://github.com/settings/tokens
2. 撤销刚才分享的令牌
3. 生成新的令牌并妥善保管

## 📋 系统性故障诊断流程

### 第一步：GitHub Actions状态检查

#### 1.1 查看Actions运行状态
```bash
# 访问您的仓库
https://github.com/velist/ai-news-pusher/actions

# 查看最新运行的workflow
# 点击失败的运行查看详细日志
```

#### 1.2 常见Actions错误及解决方案

**错误类型A：API密钥问题**
```
Error: GNEWS_API_KEY is not set
Error: Invalid API key
Error: API quota exceeded
```

**解决方案A：**
```bash
1. 检查GitHub Secrets配置：
   仓库 → Settings → Secrets and variables → Actions
   
2. 确认以下Secrets存在且正确：
   - GNEWS_API_KEY: 32位十六进制字符串
   - SILICONFLOW_API_KEY: 以sk-开头的字符串

3. 测试API密钥有效性：
   # GNews API测试
   curl "https://gnews.io/api/v4/search?q=AI&apikey=你的密钥"
   
   # 硅基流动API测试（需要POST请求）
```

**错误类型B：依赖和环境问题**
```
Error: No module named 'xxx'
Error: Python version incompatibility
Error: Timeout during installation
```

**解决方案B：**
```yaml
# 更新 .github/workflows/daily-news-push.yml
- name: 设置Python环境
  uses: actions/setup-python@v4
  with:
    python-version: '3.9'  # 固定版本避免兼容性问题

- name: 安装依赖（如果需要）
  run: |
    python -m pip install --upgrade pip
    # 如果有requirements.txt
    # pip install -r requirements.txt
```

**错误类型C：权限和推送问题**
```
Error: Permission denied
Error: Push failed
Error: Repository not found
```

**解决方案C：**
```bash
# 检查仓库权限设置
1. Settings → Actions → General
2. Workflow permissions: Read and write permissions ✅
3. Allow GitHub Actions to create and approve pull requests ✅
```

### 第二步：Vercel部署诊断

#### 2.1 Vercel部署状态检查
```bash
# 访问Vercel Dashboard
https://vercel.com/dashboard

# 查看项目状态
# 项目名称 → Deployments → 最新部署
# 查看Build Logs和Function Logs
```

#### 2.2 常见Vercel错误及解决方案

**错误类型A：构建配置问题**
```
Error: Build failed due to a user error
Error: vercel.json schema validation failed
Error: No such file or directory
```

**解决方案A：**
```json
// 检查并修复 vercel.json
{
  "version": 2,
  "cleanUrls": true,
  "trailingSlash": false,
  "rewrites": [
    {
      "source": "/",
      "destination": "/docs/index.html"
    },
    {
      "source": "/news/(.*)",
      "destination": "/docs/news/$1"
    }
  ],
  "headers": [
    {
      "source": "/docs/(.*)",
      "headers": [
        {
          "key": "Cache-Control",
          "value": "public, max-age=300"
        }
      ]
    }
  ]
}
```

**错误类型B：环境变量缺失**
```
Error: Missing environment variables
Error: GNEWS_API_KEY is not defined
```

**解决方案B：**
```bash
# Vercel项目设置中添加环境变量
1. Project Settings → Environment Variables
2. 添加：
   - GNEWS_API_KEY = 你的GNews密钥
   - SILICONFLOW_API_KEY = 你的硅基流动密钥
3. 重新部署
```

**错误类型C：文件路径问题**
```
Error: 404 - This page could not be found
Error: docs/index.html not found
```

**解决方案C：**
```bash
# 确保docs目录结构正确
docs/
├── index.html          # 主页
├── news/              # 新闻详情目录
│   ├── article1.html
│   └── article2.html
└── news_data.json     # 新闻数据
```

### 第三步：核心脚本修复

#### 3.1 超简化版本修复（推荐）

创建 `ultra_simple_news_fixed.py`：

```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
修复版超简化AI新闻推送 - 增强错误处理
"""

import os
import json
import urllib.request
import urllib.parse
from datetime import datetime, timedelta
import sys

def load_env_file():
    """加载环境变量"""
    env_path = '.env'
    if os.path.exists(env_path):
        try:
            with open(env_path, 'r', encoding='utf-8') as f:
                for line in f:
                    line = line.strip()
                    if line and not line.startswith('#') and '=' in line:
                        key, value = line.split('=', 1)
                        os.environ[key.strip()] = value.strip()
            print("✅ 环境变量加载成功")
            return True
        except Exception as e:
            print(f"⚠️ 环境变量加载失败: {e}")
            return False
    return False

def test_api_keys():
    """测试API密钥有效性"""
    gnews_key = os.getenv('GNEWS_API_KEY')
    siliconflow_key = os.getenv('SILICONFLOW_API_KEY')
    
    print("🔑 API密钥检查:")
    print(f"  GNews API: {'✅ 已设置' if gnews_key else '❌ 未设置'}")
    print(f"  硅基流动API: {'✅ 已设置' if siliconflow_key else '❌ 未设置'}")
    
    if gnews_key:
        print(f"  GNews密钥格式: {'✅ 正确' if len(gnews_key) == 32 else '❌ 格式错误'}")
    
    return gnews_key is not None

def fetch_news_with_retry(api_key, max_retries=3):
    """带重试机制的新闻获取"""
    for attempt in range(max_retries):
        try:
            print(f"📡 获取新闻中... (尝试 {attempt + 1}/{max_retries})")
            
            params = {
                "q": "AI OR OpenAI OR ChatGPT OR artificial intelligence",
                "lang": "en",
                "country": "us", 
                "max": 8,
                "apikey": api_key
            }
            
            query_string = urllib.parse.urlencode(params)
            url = f"https://gnews.io/api/v4/search?{query_string}"
            
            req = urllib.request.Request(url)
            req.add_header('User-Agent', 'Mozilla/5.0 (compatible; NewsBot/1.0)')
            
            with urllib.request.urlopen(req, timeout=15) as response:
                data = json.loads(response.read().decode())
            
            if 'articles' in data and data['articles']:
                articles = []
                for i, article in enumerate(data['articles'][:8]):
                    articles.append({
                        "id": f"ai_{i}_{int(datetime.now().timestamp())}",
                        "title": article.get('title', '无标题'),
                        "summary": article.get('description', '无描述'),
                        "source": article.get('source', {}).get('name', '未知来源'),
                        "url": article.get('url', ''),
                        "category": "AI科技",
                        "time": "刚刚"
                    })
                
                print(f"✅ 成功获取 {len(articles)} 条新闻")
                return articles
            else:
                print("⚠️ API返回空数据")
                
        except urllib.error.HTTPError as e:
            print(f"❌ HTTP错误 {e.code}: {e.reason}")
            if e.code == 429:
                print("  原因：API配额超限")
            elif e.code == 401:
                print("  原因：API密钥无效")
        except Exception as e:
            print(f"❌ 请求失败: {e}")
        
        if attempt < max_retries - 1:
            print(f"⏳ 等待 {2 ** attempt} 秒后重试...")
            import time
            time.sleep(2 ** attempt)
    
    print("❌ 所有重试均失败，使用示例数据")
    return get_sample_articles()

def get_sample_articles():
    """获取示例文章"""
    return [
        {
            "id": "sample_1",
            "title": "OpenAI发布最新GPT模型，AI能力再次突破",
            "summary": "OpenAI今日发布了最新的GPT模型，在推理能力和多模态理解方面都有显著提升，标志着人工智能技术的又一重要里程碑。",
            "source": "TechCrunch",
            "url": "https://techcrunch.com",
            "category": "AI科技",
            "time": "1小时前"
        },
        {
            "id": "sample_2",
            "title": "AI工具在企业中的应用呈现爆发式增长",
            "summary": "最新调研显示，2024年有超过80%的企业开始采用AI工具提升工作效率，AI正在从概念走向实际应用。",
            "source": "Forbes",
            "url": "https://forbes.com",
            "category": "AI产业",
            "time": "3小时前"
        },
        {
            "id": "sample_3",
            "title": "各国政府加强AI监管，确保技术安全发展",
            "summary": "美国、欧盟、中国等多个国家和地区正在制定更完善的AI监管政策，旨在平衡创新发展与安全风险。",
            "source": "Reuters",
            "url": "https://reuters.com",
            "category": "AI政策",
            "time": "5小时前"
        }
    ]

def ensure_directories():
    """确保必要目录存在"""
    try:
        os.makedirs('docs', exist_ok=True)
        os.makedirs('docs/news', exist_ok=True)
        print("✅ 目录结构检查完成")
        return True
    except Exception as e:
        print(f"❌ 创建目录失败: {e}")
        return False

def generate_enhanced_html(articles):
    """生成增强版HTML页面"""
    update_time = datetime.now().strftime('%Y年%m月%d日 %H:%M')
    
    html = f'''<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🤖 AI科技日报 - 智能新闻推送</title>
    <meta name="description" content="AI科技日报提供最新的人工智能新闻，包括OpenAI、ChatGPT等前沿科技资讯">
    <meta name="keywords" content="AI,人工智能,OpenAI,ChatGPT,科技新闻">
    <style>
        * {{ margin: 0; padding: 0; box-sizing: border-box; }}
        body {{ 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
            line-height: 1.6; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; color: #333;
        }}
        .container {{ max-width: 1200px; margin: 0 auto; padding: 20px; }}
        .header {{ 
            text-align: center; background: rgba(255,255,255,0.95); 
            border-radius: 20px; padding: 30px; margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); backdrop-filter: blur(10px);
        }}
        .header h1 {{ 
            font-size: 2.5em; margin-bottom: 10px; font-weight: 700;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }}
        .header p {{ color: #666; font-size: 1.1em; margin-bottom: 15px; }}
        .update-time {{ 
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white; padding: 8px 20px; border-radius: 25px; 
            display: inline-block; font-weight: 500;
        }}
        .stats {{ 
            display: flex; justify-content: center; gap: 30px; margin-top: 20px;
            flex-wrap: wrap;
        }}
        .stat-item {{ 
            background: rgba(102, 126, 234, 0.1); padding: 10px 20px; 
            border-radius: 12px; text-align: center;
        }}
        .stat-number {{ font-size: 1.5em; font-weight: 700; color: #667eea; }}
        .stat-label {{ font-size: 0.9em; color: #666; }}
        .news-grid {{ 
            display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); 
            gap: 25px; margin-top: 30px;
        }}
        .news-card {{ 
            background: rgba(255,255,255,0.95); border-radius: 16px; 
            padding: 25px; box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            transition: all 0.3s ease; cursor: pointer; position: relative;
            backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2);
        }}
        .news-card:hover {{ 
            transform: translateY(-5px); 
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }}
        .news-card::before {{ 
            content: ''; position: absolute; top: 0; left: 0; right: 0; 
            height: 4px; background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 16px 16px 0 0;
        }}
        .category-tag {{ 
            position: absolute; top: 15px; right: 15px;
            background: linear-gradient(45deg, #667eea, #764ba2); color: white;
            padding: 5px 12px; border-radius: 15px; font-size: 0.8em; 
            font-weight: 600; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }}
        .news-title {{ 
            font-size: 1.3em; font-weight: 600; color: #333; 
            margin-bottom: 15px; line-height: 1.4; padding-right: 80px;
        }}
        .news-summary {{ 
            color: #666; margin-bottom: 20px; line-height: 1.6;
            font-size: 0.95em;
        }}
        .news-meta {{ 
            display: flex; justify-content: space-between; align-items: center;
            padding-top: 15px; border-top: 1px solid #eee;
        }}
        .news-source {{ 
            font-weight: 600; color: #667eea; font-size: 0.9em;
        }}
        .news-time {{ 
            color: #999; font-size: 0.85em;
        }}
        .footer {{
            text-align: center; margin-top: 50px; padding: 30px;
            background: rgba(255,255,255,0.1); border-radius: 20px;
            backdrop-filter: blur(10px); color: rgba(255,255,255,0.8);
        }}
        .footer a {{ color: rgba(255,255,255,0.9); text-decoration: none; }}
        .footer a:hover {{ text-decoration: underline; }}
        @media (max-width: 768px) {{
            .container {{ padding: 15px; }}
            .header {{ padding: 20px; }}
            .header h1 {{ font-size: 2em; }}
            .news-grid {{ grid-template-columns: 1fr; }}
            .stats {{ gap: 15px; }}
            .news-title {{ padding-right: 60px; }}
        }}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🤖 AI科技日报</h1>
            <p>专注人工智能前沿资讯，每日精选优质内容</p>
            <div class="update-time">最后更新: {update_time}</div>
            <div class="stats">
                <div class="stat-item">
                    <div class="stat-number">{len(articles)}</div>
                    <div class="stat-label">今日新闻</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">24/7</div>
                    <div class="stat-label">自动更新</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">AI</div>
                    <div class="stat-label">智能筛选</div>
                </div>
            </div>
        </div>
        
        <div class="news-grid">'''
    
    for article in articles:
        html += f'''
            <div class="news-card" onclick="openDetail('{article.get('id', '')}')">
                <div class="category-tag">{article.get('category', '科技')}</div>
                <h3 class="news-title">{article.get('title', '无标题')}</h3>
                <p class="news-summary">{article.get('summary', '无摘要')}</p>
                <div class="news-meta">
                    <span class="news-source">{article.get('source', '未知来源')}</span>
                    <span class="news-time">{article.get('time', '未知时间')}</span>
                </div>
            </div>'''
    
    html += f'''
        </div>
        
        <div class="footer">
            <p>🤖 本站由AI自动生成和更新 | 数据来源：GNews API</p>
            <p>💡 <a href="https://github.com/velist/ai-news-pusher" target="_blank">查看源码</a> | 
               📧 <a href="mailto:contact@example.com">联系我们</a></p>
            <p style="margin-top: 10px; font-size: 0.8em; opacity: 0.7;">
                ⚡ 技术栈：Python + GitHub Actions + Vercel | 
                🌐 更新频率：每小时自动更新
            </p>
        </div>
    </div>
    
    <script>
        function openDetail(articleId) {{
            if (articleId && articleId !== 'sample_1' && articleId !== 'sample_2' && articleId !== 'sample_3') {{
                window.open('news/' + articleId + '.html', '_blank');
            }} else {{
                // 示例文章直接显示alert或跳转到外部链接
                alert('这是示例文章，请查看实际部署后的真实新闻链接');
            }}
        }}
        
        // 添加页面加载动画
        document.addEventListener('DOMContentLoaded', function() {{
            const cards = document.querySelectorAll('.news-card');
            cards.forEach((card, index) => {{
                card.style.opacity = '0';
                card.style.transform = 'translateY(20px)';
                setTimeout(() => {{
                    card.style.transition = 'all 0.5s ease';
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0)';
                }}, index * 100);
            }});
        }});
    </script>
</body>
</html>'''
    
    return html

def generate_detail_page(article):
    """生成新闻详情页面"""
    html = f'''<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{article.get('title', '无标题')} - AI科技日报</title>
    <style>
        body {{ 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", sans-serif;
            line-height: 1.8; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0; padding: 20px; min-height: 100vh;
        }}
        .container {{ max-width: 800px; margin: 0 auto; }}
        .back-btn {{ 
            background: rgba(255,255,255,0.9); color: #667eea; border: none;
            padding: 12px 24px; border-radius: 25px; text-decoration: none;
            display: inline-block; margin-bottom: 30px; font-weight: 600;
            transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }}
        .back-btn:hover {{ background: #667eea; color: white; transform: translateY(-2px); }}
        .article {{ 
            background: rgba(255,255,255,0.95); border-radius: 20px; 
            padding: 40px; box-shadow: 0 15px 40px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }}
        .article-title {{ 
            font-size: 2.2em; font-weight: 700; color: #333; 
            margin-bottom: 20px; line-height: 1.3;
        }}
        .article-meta {{ 
            display: flex; justify-content: space-between; align-items: center;
            padding: 20px 0; border-bottom: 2px solid #f0f0f0; margin-bottom: 30px;
        }}
        .article-source {{ font-weight: 600; color: #667eea; font-size: 1.1em; }}
        .article-time {{ color: #666; }}
        .article-category {{ 
            background: linear-gradient(45deg, #667eea, #764ba2); color: white;
            padding: 8px 16px; border-radius: 20px; font-size: 0.9em; font-weight: 600;
        }}
        .article-content {{ 
            font-size: 1.1em; color: #444; line-height: 1.8; margin-bottom: 30px;
        }}
        .read-original {{ 
            background: linear-gradient(45deg, #667eea, #764ba2); color: white;
            padding: 15px 30px; border-radius: 30px; text-decoration: none;
            display: inline-block; font-weight: 600; transition: all 0.3s ease;
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }}
        .read-original:hover {{ 
            transform: translateY(-3px); 
            box-shadow: 0 12px 25px rgba(102, 126, 234, 0.4);
        }}
        @media (max-width: 768px) {{
            .container {{ padding: 15px; }}
            .article {{ padding: 25px; }}
            .article-title {{ font-size: 1.8em; }}
        }}
    </style>
</head>
<body>
    <div class="container">
        <a href="../index.html" class="back-btn">← 返回首页</a>
        
        <div class="article">
            <h1 class="article-title">{article.get('title', '无标题')}</h1>
            
            <div class="article-meta">
                <div>
                    <span class="article-source">{article.get('source', '未知来源')}</span>
                    <span class="article-time"> • {article.get('time', '未知时间')}</span>
                </div>
                <div class="article-category">{article.get('category', '科技')}</div>
            </div>
            
            <div class="article-content">
                <p>{article.get('summary', '暂无详细内容，请点击下方链接查看原文。')}</p>
            </div>
            
            <a href="{article.get('url', '#')}" target="_blank" class="read-original">阅读原文 →</a>
        </div>
    </div>
</body>
</html>'''
    return html

def main():
    """主函数 - 增强版错误处理"""
    print("🚀 启动修复版AI新闻推送系统...")
    print("=" * 50)
    
    try:
        # 1. 加载环境变量
        load_env_file()
        
        # 2. 测试API密钥
        if not test_api_keys():
            print("⚠️ API密钥检查失败，将使用示例数据")
        
        # 3. 确保目录结构
        if not ensure_directories():
            print("❌ 无法创建必要目录，程序退出")
            return False
        
        # 4. 获取新闻数据
        api_key = os.getenv('GNEWS_API_KEY')
        if api_key:
            articles = fetch_news_with_retry(api_key)
        else:
            print("⚠️ 未找到API密钥，使用示例数据")
            articles = get_sample_articles()
        
        # 5. 生成HTML页面
        print("🌐 生成HTML页面...")
        html_content = generate_enhanced_html(articles)
        
        with open('docs/index.html', 'w', encoding='utf-8') as f:
            f.write(html_content)
        
        # 6. 生成详情页面
        print("📄 生成详情页面...")
        for article in articles:
            detail_html = generate_detail_page(article)
            detail_path = f"docs/news/{article['id']}.html"
            with open(detail_path, 'w', encoding='utf-8') as f:
                f.write(detail_html)
        
        # 7. 保存新闻数据
        news_data = {
            'last_updated': datetime.now().isoformat(),
            'total_count': len(articles),
            'articles': articles
        }
        
        with open('docs/news_data.json', 'w', encoding='utf-8') as f:
            json.dump(news_data, f, ensure_ascii=False, indent=2)
        
        print(f"✅ 成功生成 {len(articles)} 条新闻")
        print(f"✅ 生成了 {len(articles)} 个详情页面")
        print("✅ 保存了新闻数据文件")
        
        # 8. 验证生成的文件
        required_files = ['docs/index.html', 'docs/news_data.json']
        for file_path in required_files:
            if os.path.exists(file_path):
                size = os.path.getsize(file_path)
                print(f"✅ {file_path} ({size} bytes)")
            else:
                print(f"❌ {file_path} 不存在")
        
        print("\n🎉 AI新闻推送系统运行完成!")
        print("🌐 本地预览: 打开 docs/index.html")
        return True
        
    except Exception as e:
        print(f"❌ 系统运行失败: {e}")
        import traceback
        traceback.print_exc()
        
        # 紧急备用方案
        try:
            print("🆘 启动紧急备用方案...")
            ensure_directories()
            articles = get_sample_articles()
            html_content = generate_enhanced_html(articles)
            
            with open('docs/index.html', 'w', encoding='utf-8') as f:
                f.write(html_content)
            
            print("✅ 紧急备用页面已生成")
            return True
        except:
            print("❌ 紧急备用方案也失败了")
            return False

if __name__ == "__main__":
    success = main()
    sys.exit(0 if success else 1)
```

#### 3.2 GitHub Actions工作流修复

更新 `.github/workflows/daily-news-push.yml`：

```yaml
name: AI新闻每日推送 - 修复版

on:
  schedule:
    # 每2小时运行一次，避免过于频繁
    - cron: '0 */2 * * *'
  workflow_dispatch:
    inputs:
      force_update:
        description: '强制更新'
        required: false
        default: 'false'

jobs:
  push-news:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: 设置Python环境
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        cache: 'pip'
        
    - name: 检查环境变量
      run: |
        echo "检查必要的环境变量..."
        if [ -z "${{ secrets.GNEWS_API_KEY }}" ]; then
          echo "❌ GNEWS_API_KEY 未设置"
          exit 1
        else
          echo "✅ GNEWS_API_KEY 已设置"
        fi
        
    - name: 运行AI新闻推送
      env:
        GNEWS_API_KEY: ${{ secrets.GNEWS_API_KEY }}
        SILICONFLOW_API_KEY: ${{ secrets.SILICONFLOW_API_KEY }}
      run: |
        echo "🚀 开始运行AI新闻推送..."
        
        # 使用修复版脚本
        if [ -f "ultra_simple_news_fixed.py" ]; then
          python ultra_simple_news_fixed.py
        else
          python ultra_simple_news.py
        fi
        
        echo "📊 检查生成结果..."
        if [ -f "docs/index.html" ]; then
          echo "✅ index.html 已生成 ($(wc -c < docs/index.html) bytes)"
        else
          echo "❌ index.html 生成失败"
          exit 1
        fi
        
    - name: 检查文件变化
      id: changes
      run: |
        git add docs/
        if git diff --cached --quiet; then
          echo "has_changes=false" >> $GITHUB_OUTPUT
          echo "📝 没有文件变化"
        else
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "📝 检测到文件变化"
          git diff --cached --stat
        fi
        
    - name: 提交更新
      if: steps.changes.outputs.has_changes == 'true' || github.event.inputs.force_update == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action Bot"
        
        # 提交变化
        git add docs/
        git commit -m "🚀 AI新闻自动更新 - $(date '+%Y-%m-%d %H:%M') UTC" || echo "无需提交"
        
        # 推送到远程仓库
        git push origin main || {
          echo "❌ 推送失败，尝试强制推送..."
          git push --force-with-lease origin main
        }
        
        echo "✅ 更新已提交并推送"
        
    - name: 部署状态报告
      if: always()
      run: |
        echo "=== 🎯 部署状态报告 ==="
        echo "⏰ 运行时间: $(date)"
        echo "🔄 工作流: ${{ github.workflow }}"
        echo "📂 仓库: ${{ github.repository }}"
        
        if [ -f "docs/index.html" ]; then
          echo "✅ 主页: docs/index.html ($(wc -c < docs/index.html) bytes)"
        else
          echo "❌ 主页: 生成失败"
        fi
        
        if [ -f "docs/news_data.json" ]; then
          echo "✅ 数据: docs/news_data.json ($(wc -c < docs/news_data.json) bytes)"
        else
          echo "❌ 数据: 生成失败"
        fi
        
        echo "🌐 访问地址:"
        echo "  - GitHub Pages: https://${{ github.repository_owner }}.github.io/${GITHUB_REPOSITORY#*/}/"
        echo "  - Vercel: https://ai-news-pusher.vercel.app/"
        
        echo "=== 📋 下一步建议 ==="
        echo "1. 检查 Vercel 自动部署状态"
        echo "2. 验证 GitHub Pages 更新"
        echo "3. 测试网站访问和功能"
```

### 第四步：快速修复执行

#### 4.1 立即执行的修复步骤

```bash
# 1. 检查并撤销泄露的GitHub令牌
# 访问: https://github.com/settings/tokens
# 找到泄露的令牌并立即删除

# 2. 检查GitHub Secrets配置
# 访问: https://github.com/velist/ai-news-pusher/settings/secrets/actions
# 确认以下Secrets存在:
# - GNEWS_API_KEY
# - SILICONFLOW_API_KEY (可选)

# 3. 检查API密钥有效性
# GNews API测试 (替换YOUR_API_KEY):
curl "https://gnews.io/api/v4/search?q=AI&max=1&apikey=YOUR_API_KEY"

# 4. 手动触发GitHub Actions
# 访问: https://github.com/velist/ai-news-pusher/actions
# 点击 "Run workflow" 手动触发

# 5. 检查Vercel项目状态
# 访问: https://vercel.com/dashboard
# 检查项目部署日志和环境变量
```

#### 4.2 Vercel快速修复

```json
// 确保 vercel.json 配置正确
{
  "version": 2,
  "cleanUrls": true,
  "trailingSlash": false,
  "rewrites": [
    {
      "source": "/",
      "destination": "/docs/index.html"
    }
  ],
  "headers": [
    {
      "source": "/docs/(.*)",
      "headers": [
        {
          "key": "Cache-Control", 
          "value": "public, max-age=300"
        }
      ]
    }
  ]
}
```

```bash
# Vercel环境变量检查清单:
# 项目设置 → Environment Variables
# 
# 必需变量:
# - GNEWS_API_KEY = 你的GNews API密钥
# 
# 可选变量:
# - SILICONFLOW_API_KEY = 你的硅基流动API密钥
```

## 🆘 紧急联系和支持

如果以上步骤仍无法解决问题，建议：

1. **GitHub Issues**: 在仓库中创建详细的问题反馈
2. **检查日志**: 仔细查看Actions和Vercel的错误日志
3. **API限额**: 确认所有API服务都有足够配额
4. **网络问题**: 检查是否存在网络访问限制

## 📋 问题排查检查清单

- [ ] GitHub令牌已撤销并重新生成
- [ ] GitHub Secrets配置正确
- [ ] API密钥有效且有配额
- [ ] GitHub Actions权限设置正确
- [ ] Vercel环境变量配置完整
- [ ] vercel.json语法正确
- [ ] docs目录结构完整

---

**创建时间**: 2025年1月27日
**适用版本**: 所有版本
**更新状态**: 实时维护